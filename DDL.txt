CREATE TABLE edu.analytics_metric (
	metric_code varchar(50) NOT NULL,
	name_ru text NOT NULL,
	category varchar(30) NULL,
	unit varchar(20) NULL,
	description text NULL,
	is_active bool DEFAULT true NOT NULL,
	CONSTRAINT analytics_metric_pkey PRIMARY KEY (metric_code),
	CONSTRAINT chk_metric_category CHECK (((category IS NULL) OR ((category)::text = ANY ((ARRAY['ege'::character varying, 'admission'::character varying, 'prof_orientation'::character varying, 'school_info'::character varying])::text[]))))
);
CREATE TABLE edu.analytics_rating_run (
	run_id int4 GENERATED BY DEFAULT AS IDENTITY( INCREMENT BY 1 MINVALUE 1 MAXVALUE 2147483647 START 1 CACHE 1 NO CYCLE) NOT NULL,
	request_id int4 NOT NULL,
	calculated_at timestamptz DEFAULT now() NOT NULL,
	calculated_by varchar(100) NULL,
	run_name varchar(200) NULL,
	stage varchar(10) DEFAULT 'final'::character varying NOT NULL,
	algorithm_version varchar(32) DEFAULT 'v1'::character varying NOT NULL,
	normalization varchar(20) DEFAULT 'minmax'::character varying NULL,
	"comment" text NULL,
	CONSTRAINT analytics_rating_run_pkey PRIMARY KEY (run_id),
	CONSTRAINT chk_normalization CHECK (((normalization)::text = ANY ((ARRAY['minmax'::character varying, 'zscore'::character varying, 'rank'::character varying])::text[]))),
	CONSTRAINT chk_run_stage CHECK (((stage)::text = ANY ((ARRAY['prelim'::character varying, 'final'::character varying])::text[]))),
	CONSTRAINT analytics_rating_run_request_id_fkey FOREIGN KEY (request_id) REFERENCES edu.analytics_request(request_id) ON DELETE CASCADE ON UPDATE CASCADE
);
CREATE INDEX idx_rating_run_created ON edu.analytics_rating_run USING btree (calculated_at DESC);
CREATE INDEX idx_rating_run_request ON edu.analytics_rating_run USING btree (request_id);
CREATE INDEX idx_rating_run_stage ON edu.analytics_rating_run USING btree (stage);

CREATE TABLE edu.analytics_request (
	request_id int4 GENERATED BY DEFAULT AS IDENTITY( INCREMENT BY 1 MINVALUE 1 MAXVALUE 2147483647 START 1 CACHE 1 NO CYCLE) NOT NULL,
	created_at timestamptz DEFAULT now() NOT NULL,
	created_by varchar(100) NULL,
	request_name varchar(200) NULL,
	scenario varchar(12) NOT NULL,
	year_basis int2 NOT NULL,
	only_active bool DEFAULT true NOT NULL,
	min_students int4 NULL,
	max_students int4 NULL,
	notes text NULL,
	CONSTRAINT analytics_request_pkey PRIMARY KEY (request_id),
	CONSTRAINT chk_req_scenario CHECK (((scenario)::text = ANY ((ARRAY['selection'::character varying, 'search'::character varying])::text[]))),
	CONSTRAINT chk_req_students CHECK ((((min_students IS NULL) OR (min_students >= 0)) AND ((max_students IS NULL) OR (max_students >= 0)) AND ((min_students IS NULL) OR (max_students IS NULL) OR (min_students <= max_students)))),
	CONSTRAINT chk_req_year_basis CHECK (((year_basis >= 2000) AND (year_basis <= 2100)))
);
CREATE INDEX idx_analytics_request_created ON edu.analytics_request USING btree (created_at DESC);
CREATE INDEX idx_analytics_request_scenario ON edu.analytics_request USING btree (scenario);
CREATE INDEX idx_analytics_request_year ON edu.analytics_request USING btree (year_basis);CREATE TABLE edu.analytics_request_filter (
	filter_id int4 GENERATED BY DEFAULT AS IDENTITY( INCREMENT BY 1 MINVALUE 1 MAXVALUE 2147483647 START 1 CACHE 1 NO CYCLE) NOT NULL,
	request_id int4 NOT NULL,
	filter_type varchar(30) NOT NULL,
	region_id int4 NULL,
	municipality_id int4 NULL,
	institute_id int4 NULL,
	profile_id int4 NULL,
	program_id int4 NULL,
	subject_id int4 NULL,
	school_id int4 NULL,
	min_score int2 NULL,
	CONSTRAINT analytics_request_filter_pkey PRIMARY KEY (filter_id),
	CONSTRAINT chk_filter_min_score CHECK (((min_score IS NULL) OR ((min_score >= 0) AND (min_score <= 100)))),
	CONSTRAINT chk_filter_payload CHECK (((((filter_type)::text = 'region'::text) AND (region_id IS NOT NULL) AND (municipality_id IS NULL) AND (institute_id IS NULL) AND (profile_id IS NULL) AND (program_id IS NULL) AND (subject_id IS NULL) AND (school_id IS NULL) AND (min_score IS NULL)) OR (((filter_type)::text = 'municipality'::text) AND (municipality_id IS NOT NULL) AND (region_id IS NULL) AND (institute_id IS NULL) AND (profile_id IS NULL) AND (program_id IS NULL) AND (subject_id IS NULL) AND (school_id IS NULL) AND (min_score IS NULL)) OR (((filter_type)::text = 'institute'::text) AND (institute_id IS NOT NULL) AND (region_id IS NULL) AND (municipality_id IS NULL) AND (profile_id IS NULL) AND (program_id IS NULL) AND (subject_id IS NULL) AND (school_id IS NULL) AND (min_score IS NULL)) OR (((filter_type)::text = 'school_profile'::text) AND (profile_id IS NOT NULL) AND (region_id IS NULL) AND (municipality_id IS NULL) AND (institute_id IS NULL) AND (program_id IS NULL) AND (subject_id IS NULL) AND (school_id IS NULL) AND (min_score IS NULL)) OR (((filter_type)::text = 'program'::text) AND (program_id IS NOT NULL) AND (region_id IS NULL) AND (municipality_id IS NULL) AND (institute_id IS NULL) AND (profile_id IS NULL) AND (subject_id IS NULL) AND (school_id IS NULL) AND (min_score IS NULL)) OR (((filter_type)::text = 'subject'::text) AND (subject_id IS NOT NULL) AND (region_id IS NULL) AND (municipality_id IS NULL) AND (institute_id IS NULL) AND (profile_id IS NULL) AND (program_id IS NULL) AND (school_id IS NULL)) OR (((filter_type)::text = 'school'::text) AND (school_id IS NOT NULL) AND (region_id IS NULL) AND (municipality_id IS NULL) AND (institute_id IS NULL) AND (profile_id IS NULL) AND (program_id IS NULL) AND (subject_id IS NULL) AND (min_score IS NULL)))),
	CONSTRAINT chk_filter_type CHECK (((filter_type)::text = ANY ((ARRAY['region'::character varying, 'municipality'::character varying, 'institute'::character varying, 'school_profile'::character varying, 'program'::character varying, 'subject'::character varying, 'school'::character varying])::text[]))),
	CONSTRAINT analytics_request_filter_institute_id_fkey FOREIGN KEY (institute_id) REFERENCES edu.institute(institute_id) ON DELETE RESTRICT ON UPDATE CASCADE,
	CONSTRAINT analytics_request_filter_municipality_id_fkey FOREIGN KEY (municipality_id) REFERENCES edu.municipality(municipality_id) ON DELETE RESTRICT ON UPDATE CASCADE,
	CONSTRAINT analytics_request_filter_profile_id_fkey FOREIGN KEY (profile_id) REFERENCES edu.school_profile(profile_id) ON DELETE RESTRICT ON UPDATE CASCADE,
	CONSTRAINT analytics_request_filter_program_id_fkey FOREIGN KEY (program_id) REFERENCES edu.study_program(program_id) ON DELETE RESTRICT ON UPDATE CASCADE,
	CONSTRAINT analytics_request_filter_region_id_fkey FOREIGN KEY (region_id) REFERENCES edu.region(region_id) ON DELETE RESTRICT ON UPDATE CASCADE,
	CONSTRAINT analytics_request_filter_request_id_fkey FOREIGN KEY (request_id) REFERENCES edu.analytics_request(request_id) ON DELETE CASCADE ON UPDATE CASCADE,
	CONSTRAINT analytics_request_filter_school_id_fkey FOREIGN KEY (school_id) REFERENCES edu.school(school_id) ON DELETE RESTRICT ON UPDATE CASCADE,
	CONSTRAINT analytics_request_filter_subject_id_fkey FOREIGN KEY (subject_id) REFERENCES edu.ege_subject(subject_id) ON DELETE RESTRICT ON UPDATE CASCADE
);
CREATE INDEX idx_req_filter_request ON edu.analytics_request_filter USING btree (request_id);
CREATE INDEX idx_req_filter_type ON edu.analytics_request_filter USING btree (filter_type);
CREATE UNIQUE INDEX uq_req_filter_item ON edu.analytics_request_filter USING btree (request_id, filter_type, COALESCE(region_id, '-1'::integer), COALESCE(municipality_id, '-1'::integer), COALESCE(institute_id, '-1'::integer), COALESCE(profile_id, '-1'::integer), COALESCE(program_id, '-1'::integer), COALESCE(subject_id, '-1'::integer), COALESCE(school_id, '-1'::integer));
CREATE TABLE edu.analytics_run_metric (
	run_id int4 NOT NULL,
	metric_code varchar(50) NOT NULL,
	weight int2 DEFAULT 1 NOT NULL,
	is_primary bool DEFAULT false NOT NULL,
	CONSTRAINT analytics_run_metric_pkey PRIMARY KEY (run_id, metric_code),
	CONSTRAINT chk_run_metric_weight CHECK (((weight >= 1) AND (weight <= 10))),
	CONSTRAINT analytics_run_metric_metric_code_fkey FOREIGN KEY (metric_code) REFERENCES edu.analytics_metric(metric_code) ON DELETE RESTRICT ON UPDATE CASCADE,
	CONSTRAINT analytics_run_metric_run_id_fkey FOREIGN KEY (run_id) REFERENCES edu.analytics_rating_run(run_id) ON DELETE CASCADE ON UPDATE CASCADE
);
CREATE INDEX idx_run_metric_run ON edu.analytics_run_metric USING btree (run_id);
CREATE UNIQUE INDEX uq_run_one_primary_metric ON edu.analytics_run_metric USING btree (run_id) WHERE (is_primary = true);
CREATE TABLE edu.analytics_run_school (
	run_id int4 NOT NULL,
	school_id int4 NOT NULL,
	selected_at timestamptz DEFAULT now() NOT NULL,
	CONSTRAINT analytics_run_school_pkey PRIMARY KEY (run_id, school_id),
	CONSTRAINT analytics_run_school_run_id_fkey FOREIGN KEY (run_id) REFERENCES edu.analytics_rating_run(run_id) ON DELETE CASCADE ON UPDATE CASCADE,
	CONSTRAINT analytics_run_school_school_id_fkey FOREIGN KEY (school_id) REFERENCES edu.school(school_id) ON DELETE RESTRICT ON UPDATE CASCADE
);
CREATE INDEX idx_run_school_run ON edu.analytics_run_school USING btree (run_id);
CREATE TABLE edu.analytics_school_card (
	card_id int4 GENERATED BY DEFAULT AS IDENTITY( INCREMENT BY 1 MINVALUE 1 MAXVALUE 2147483647 START 1 CACHE 1 NO CYCLE) NOT NULL,
	run_id int4 NOT NULL,
	school_id int4 NOT NULL,
	generated_at timestamptz DEFAULT now() NOT NULL,
	school_info jsonb DEFAULT '{}'::jsonb NOT NULL,
	ege_summary jsonb DEFAULT '{}'::jsonb NOT NULL,
	admission_summary jsonb DEFAULT '{}'::jsonb NOT NULL,
	prof_summary jsonb DEFAULT '{}'::jsonb NOT NULL,
	conclusions jsonb DEFAULT '{}'::jsonb NOT NULL,
	CONSTRAINT analytics_school_card_pkey PRIMARY KEY (card_id),
	CONSTRAINT uq_card_per_run_school UNIQUE (run_id, school_id),
	CONSTRAINT analytics_school_card_run_id_fkey FOREIGN KEY (run_id) REFERENCES edu.analytics_rating_run(run_id) ON DELETE CASCADE ON UPDATE CASCADE,
	CONSTRAINT analytics_school_card_school_id_fkey FOREIGN KEY (school_id) REFERENCES edu.school(school_id) ON DELETE RESTRICT ON UPDATE CASCADE
);
CREATE INDEX idx_school_card_run ON edu.analytics_school_card USING btree (run_id);
CREATE INDEX idx_school_card_school ON edu.analytics_school_card USING btree (school_id);
CREATE TABLE edu.analytics_school_metric_value (
	run_id int4 NOT NULL,
	school_id int4 NOT NULL,
	metric_code varchar(50) NOT NULL,
	raw_value numeric(5, 2) NULL,
	norm_value numeric(10, 6) NULL,
	weighted_value numeric(10, 6) NULL,
	CONSTRAINT analytics_school_metric_value_pkey PRIMARY KEY (run_id, school_id, metric_code),
	CONSTRAINT analytics_school_metric_value_metric_code_fkey FOREIGN KEY (metric_code) REFERENCES edu.analytics_metric(metric_code) ON DELETE RESTRICT ON UPDATE CASCADE,
	CONSTRAINT analytics_school_metric_value_run_id_fkey FOREIGN KEY (run_id) REFERENCES edu.analytics_rating_run(run_id) ON DELETE CASCADE ON UPDATE CASCADE,
	CONSTRAINT analytics_school_metric_value_school_id_fkey FOREIGN KEY (school_id) REFERENCES edu.school(school_id) ON DELETE RESTRICT ON UPDATE CASCADE
);
CREATE INDEX idx_metric_value_metric ON edu.analytics_school_metric_value USING btree (metric_code);
CREATE INDEX idx_metric_value_run_metric_school ON edu.analytics_school_metric_value USING btree (run_id, metric_code, school_id);
CREATE INDEX idx_metric_value_run_school ON edu.analytics_school_metric_value USING btree (run_id, school_id);
CREATE TABLE edu.analytics_school_rating (
	run_id int4 NOT NULL,
	school_id int4 NOT NULL,
	rank_pos int4 NOT NULL,
	total_score numeric(12, 6) DEFAULT 0 NOT NULL,
	year_basis int2 NULL,
	students_cnt int4 NULL,
	ege_avg_all numeric(5, 2) NULL,
	CONSTRAINT analytics_school_rating_pkey PRIMARY KEY (run_id, school_id),
	CONSTRAINT chk_rank_pos CHECK ((rank_pos >= 1)),
	CONSTRAINT uq_rank_per_run UNIQUE (run_id, rank_pos),
	CONSTRAINT analytics_school_rating_run_id_fkey FOREIGN KEY (run_id) REFERENCES edu.analytics_rating_run(run_id) ON DELETE CASCADE ON UPDATE CASCADE,
	CONSTRAINT analytics_school_rating_school_id_fkey FOREIGN KEY (school_id) REFERENCES edu.school(school_id) ON DELETE RESTRICT ON UPDATE CASCADE
);
CREATE INDEX idx_school_rating_rank ON edu.analytics_school_rating USING btree (run_id, rank_pos);
CREATE INDEX idx_school_rating_run ON edu.analytics_school_rating USING btree (run_id);
CREATE INDEX idx_school_rating_score ON edu.analytics_school_rating USING btree (total_score DESC);
CREATE TABLE edu.analytics_school_report (
	report_id int4 GENERATED BY DEFAULT AS IDENTITY( INCREMENT BY 1 MINVALUE 1 MAXVALUE 2147483647 START 1 CACHE 1 NO CYCLE) NOT NULL,
	run_id int4 NOT NULL,
	school_id int4 NOT NULL,
	report_type varchar(20) DEFAULT 'standard'::character varying NOT NULL,
	generated_at timestamptz DEFAULT now() NOT NULL,
	report_format varchar(10) DEFAULT 'json'::character varying NULL,
	report_payload jsonb NOT NULL,
	CONSTRAINT analytics_school_report_pkey PRIMARY KEY (report_id),
	CONSTRAINT chk_report_format CHECK (((report_format IS NULL) OR ((report_format)::text = ANY ((ARRAY['json'::character varying, 'pdf'::character varying, 'xlsx'::character varying])::text[])))),
	CONSTRAINT chk_report_type CHECK (((report_type)::text = ANY ((ARRAY['standard'::character varying, 'detailed'::character varying, 'comparison'::character varying, 'timeline'::character varying])::text[]))),
	CONSTRAINT analytics_school_report_run_id_fkey FOREIGN KEY (run_id) REFERENCES edu.analytics_rating_run(run_id) ON DELETE CASCADE ON UPDATE CASCADE,
	CONSTRAINT analytics_school_report_school_id_fkey FOREIGN KEY (school_id) REFERENCES edu.school(school_id) ON DELETE RESTRICT ON UPDATE CASCADE
);
CREATE INDEX idx_school_report_run ON edu.analytics_school_report USING btree (run_id);
CREATE INDEX idx_school_report_type ON edu.analytics_school_report USING btree (report_type);
CREATE TABLE edu.analytics_school_selection (
	request_id int4 NOT NULL,
	school_id int4 NOT NULL,
	selected_at timestamptz DEFAULT now() NOT NULL,
	match_score numeric(5, 2) NULL,
	CONSTRAINT analytics_school_selection_pkey PRIMARY KEY (request_id, school_id),
	CONSTRAINT analytics_school_selection_request_id_fkey FOREIGN KEY (request_id) REFERENCES edu.analytics_request(request_id) ON DELETE CASCADE ON UPDATE CASCADE,
	CONSTRAINT analytics_school_selection_school_id_fkey FOREIGN KEY (school_id) REFERENCES edu.school(school_id) ON DELETE RESTRICT ON UPDATE CASCADE
);
CREATE INDEX idx_school_selection_match ON edu.analytics_school_selection USING btree (match_score DESC) WHERE (match_score IS NOT NULL);
CREATE INDEX idx_school_selection_request ON edu.analytics_school_selection USING btree (request_id);
CREATE INDEX idx_school_selection_school ON edu.analytics_school_selection USING btree (school_id);
CREATE TABLE edu.ege_school_subject_stat (
	ege_school_subject_stat_id int4 GENERATED BY DEFAULT AS IDENTITY( INCREMENT BY 1 MINVALUE 1 MAXVALUE 2147483647 START 1 CACHE 1 NO CYCLE) NOT NULL,
	ege_school_year_id int4 NOT NULL,
	subject_id int4 NOT NULL,
	participants_cnt int4 NULL,
	not_passed_cnt int4 NULL,
	high_80_99_cnt int4 NULL,
	score_100_cnt int4 NULL,
	avg_score numeric(5, 2) NULL,
	chosen_cnt int4 NULL,
	CONSTRAINT chk_100_le_part CHECK (((participants_cnt IS NULL) OR (score_100_cnt IS NULL) OR (score_100_cnt <= participants_cnt))),
	CONSTRAINT chk_100_nonneg CHECK (((score_100_cnt IS NULL) OR (score_100_cnt >= 0))),
	CONSTRAINT chk_80_99_le_part CHECK (((participants_cnt IS NULL) OR (high_80_99_cnt IS NULL) OR (high_80_99_cnt <= participants_cnt))),
	CONSTRAINT chk_avg_score CHECK (((avg_score IS NULL) OR ((avg_score >= (0)::numeric) AND (avg_score <= (100)::numeric)))),
	CONSTRAINT chk_chosen_nonneg CHECK (((chosen_cnt IS NULL) OR (chosen_cnt >= 0))),
	CONSTRAINT chk_high_nonneg CHECK (((high_80_99_cnt IS NULL) OR (high_80_99_cnt >= 0))),
	CONSTRAINT chk_not_passed_le_part CHECK (((participants_cnt IS NULL) OR (not_passed_cnt IS NULL) OR (not_passed_cnt <= participants_cnt))),
	CONSTRAINT chk_not_passed_nonneg CHECK (((not_passed_cnt IS NULL) OR (not_passed_cnt >= 0))),
	CONSTRAINT chk_participants_nonneg CHECK (((participants_cnt IS NULL) OR (participants_cnt >= 0))),
	CONSTRAINT ege_school_subject_stat_pkey PRIMARY KEY (ege_school_subject_stat_id),
	CONSTRAINT uq_ege_school_year_subject UNIQUE (ege_school_year_id, subject_id),
	CONSTRAINT ege_school_subject_stat_ege_school_year_id_fkey FOREIGN KEY (ege_school_year_id) REFERENCES edu.ege_school_year(ege_school_year_id) ON DELETE CASCADE ON UPDATE CASCADE,
	CONSTRAINT ege_school_subject_stat_subject_id_fkey FOREIGN KEY (subject_id) REFERENCES edu.ege_subject(subject_id) ON DELETE RESTRICT ON UPDATE CASCADE
);
CREATE INDEX idx_ege_school_subject_stat_subject ON edu.ege_school_subject_stat USING btree (subject_id);
CREATE INDEX idx_ege_subject_stat_avg_score ON edu.ege_school_subject_stat USING btree (avg_score);
CREATE INDEX idx_ege_subject_stat_year_subject ON edu.ege_school_subject_stat USING btree (ege_school_year_id, subject_id);
CREATE TABLE edu.ege_school_year (
	ege_school_year_id int4 GENERATED BY DEFAULT AS IDENTITY( INCREMENT BY 1 MINVALUE 1 MAXVALUE 2147483647 START 1 CACHE 1 NO CYCLE) NOT NULL,
	school_id int4 NOT NULL,
	"year" int2 NOT NULL,
	kind edu."ege_dataset_kind" DEFAULT 'actual'::edu.ege_dataset_kind NOT NULL,
	graduates_total int4 DEFAULT 0 NOT NULL,
	CONSTRAINT chk_ege_year CHECK (((year >= 2000) AND (year <= 2100))),
	CONSTRAINT chk_graduates_total CHECK ((graduates_total >= 0)),
	CONSTRAINT ege_school_year_pkey PRIMARY KEY (ege_school_year_id),
	CONSTRAINT uq_ege_school_year UNIQUE (school_id, year, kind),
	CONSTRAINT ege_school_year_school_id_fkey FOREIGN KEY (school_id) REFERENCES edu.school(school_id) ON DELETE CASCADE ON UPDATE CASCADE
);
CREATE INDEX idx_ege_school_year_school_year_kind ON edu.ege_school_year USING btree (school_id, year, kind);
CREATE INDEX idx_ege_school_year_year ON edu.ege_school_year USING btree (year);
CREATE TABLE edu.ege_subject (
	subject_id int4 GENERATED BY DEFAULT AS IDENTITY( INCREMENT BY 1 MINVALUE 1 MAXVALUE 2147483647 START 1 CACHE 1 NO CYCLE) NOT NULL,
	"name" text NOT NULL,
	min_passing_score numeric(3) NULL,
	CONSTRAINT chk_subject_min_score CHECK (((min_passing_score IS NULL) OR ((min_passing_score >= (0)::numeric) AND (min_passing_score <= (100)::numeric)))),
	CONSTRAINT ege_subject_name_key UNIQUE (name),
	CONSTRAINT ege_subject_pkey PRIMARY KEY (subject_id)
);
CREATE TABLE edu.institute (
	institute_id int4 GENERATED BY DEFAULT AS IDENTITY( INCREMENT BY 1 MINVALUE 1 MAXVALUE 2147483647 START 1 CACHE 1 NO CYCLE) NOT NULL,
	"name" text NOT NULL,
	CONSTRAINT institute_name_key UNIQUE (name),
	CONSTRAINT institute_pkey PRIMARY KEY (institute_id)
);
CREATE TABLE edu.municipality (
	municipality_id int4 GENERATED BY DEFAULT AS IDENTITY( INCREMENT BY 1 MINVALUE 1 MAXVALUE 2147483647 START 1 CACHE 1 NO CYCLE) NOT NULL,
	region_id int4 NOT NULL,
	"name" text NOT NULL,
	CONSTRAINT municipality_pkey PRIMARY KEY (municipality_id),
	CONSTRAINT uq_municipality_region_name UNIQUE (region_id, name),
	CONSTRAINT municipality_region_id_fkey FOREIGN KEY (region_id) REFERENCES edu.region(region_id) ON DELETE CASCADE
);
CREATE INDEX idx_municipality_region_id ON edu.municipality USING btree (region_id);
CREATE TABLE edu.prof_event (
	event_id int4 GENERATED BY DEFAULT AS IDENTITY( INCREMENT BY 1 MINVALUE 1 MAXVALUE 2147483647 START 1 CACHE 1 NO CYCLE) NOT NULL,
	school_id int4 NOT NULL,
	institute_id int4 NOT NULL,
	event_date date NOT NULL,
	coverage_cnt int4 DEFAULT 0 NOT NULL,
	event_type varchar(50) NULL,
	external_key text NULL,
	CONSTRAINT chk_coverage_nonneg CHECK ((coverage_cnt >= 0)),
	CONSTRAINT prof_event_pkey PRIMARY KEY (event_id),
	CONSTRAINT prof_event_institute_id_fkey FOREIGN KEY (institute_id) REFERENCES edu.institute(institute_id) ON DELETE RESTRICT ON UPDATE CASCADE,
	CONSTRAINT prof_event_school_id_fkey FOREIGN KEY (school_id) REFERENCES edu.school(school_id) ON DELETE CASCADE ON UPDATE CASCADE
);
CREATE INDEX idx_prof_event_date ON edu.prof_event USING btree (event_date);
CREATE INDEX idx_prof_event_school_date ON edu.prof_event USING btree (school_id, event_date);
CREATE TABLE edu.program_ege_requirement (
	req_id int4 GENERATED BY DEFAULT AS IDENTITY( INCREMENT BY 1 MINVALUE 1 MAXVALUE 2147483647 START 1 CACHE 1 NO CYCLE) NOT NULL,
	program_id int4 NOT NULL,
	subject_id int4 NOT NULL,
	"role" varchar(10) NOT NULL,
	weight int2 DEFAULT 1 NOT NULL,
	CONSTRAINT chk_req_role CHECK (((role)::text = ANY ((ARRAY['required'::character varying, 'choice'::character varying])::text[]))),
	CONSTRAINT chk_req_weight CHECK ((weight = ANY (ARRAY[1, 2, 3]))),
	CONSTRAINT chk_weight1_required CHECK (((weight <> 1) OR ((role)::text = 'required'::text))),
	CONSTRAINT program_ege_requirement_pkey PRIMARY KEY (req_id),
	CONSTRAINT uq_program_subject UNIQUE (program_id, subject_id),
	CONSTRAINT program_ege_requirement_program_id_fkey FOREIGN KEY (program_id) REFERENCES edu.study_program(program_id) ON DELETE CASCADE ON UPDATE CASCADE,
	CONSTRAINT program_ege_requirement_subject_id_fkey FOREIGN KEY (subject_id) REFERENCES edu.ege_subject(subject_id) ON DELETE RESTRICT ON UPDATE CASCADE
);
CREATE INDEX idx_program_ege_req_program_id ON edu.program_ege_requirement USING btree (program_id);
CREATE INDEX idx_program_ege_req_subject_id ON edu.program_ege_requirement USING btree (subject_id);
CREATE TABLE edu.region (
	region_id int4 GENERATED BY DEFAULT AS IDENTITY( INCREMENT BY 1 MINVALUE 1 MAXVALUE 2147483647 START 1 CACHE 1 NO CYCLE) NOT NULL,
	"name" text NOT NULL,
	CONSTRAINT region_name_key UNIQUE (name),
	CONSTRAINT region_pkey PRIMARY KEY (region_id)
);
CREATE TABLE edu.school (
	school_id int4 GENERATED BY DEFAULT AS IDENTITY( INCREMENT BY 1 MINVALUE 1 MAXVALUE 2147483647 START 1 CACHE 1 NO CYCLE) NOT NULL,
	municipality_id int4 NOT NULL,
	full_name text NOT NULL,
	is_active bool DEFAULT true NOT NULL,
	CONSTRAINT school_pkey PRIMARY KEY (school_id),
	CONSTRAINT uq_school_municipality_full_name UNIQUE (municipality_id, full_name),
	CONSTRAINT school_municipality_id_fkey FOREIGN KEY (municipality_id) REFERENCES edu.municipality(municipality_id) ON DELETE CASCADE
);
CREATE INDEX idx_school_full_name_norm_trgm ON edu.school USING gin (lower(replace(replace(regexp_replace(COALESCE(full_name, ''::text), '\s+'::text, ' '::text, 'g'::text), 'Ё'::text, 'Е'::text), 'ё'::text, 'е'::text)) gin_trgm_ops);
CREATE INDEX idx_school_municipality_id ON edu.school USING btree (municipality_id);
CREATE TABLE edu.school_admission_detail (
	detail_id int4 GENERATED BY DEFAULT AS IDENTITY( INCREMENT BY 1 MINVALUE 1 MAXVALUE 2147483647 START 1 CACHE 1 NO CYCLE) NOT NULL,
	adm_stat_id int4 NOT NULL,
	program_id int4 NOT NULL,
	applicants_cnt int4 DEFAULT 0 NOT NULL,
	enrolled_cnt int4 DEFAULT 0 NOT NULL,
	avg_score numeric(5, 2) NULL,
	CONSTRAINT chk_adm_det_app_nonneg CHECK ((applicants_cnt >= 0)),
	CONSTRAINT chk_adm_det_avg_score CHECK (((avg_score IS NULL) OR ((avg_score >= (0)::numeric) AND (avg_score <= (100)::numeric)))),
	CONSTRAINT chk_adm_det_enr_le_app CHECK ((enrolled_cnt <= applicants_cnt)),
	CONSTRAINT chk_adm_det_enr_nonneg CHECK ((enrolled_cnt >= 0)),
	CONSTRAINT school_admission_detail_pkey PRIMARY KEY (detail_id),
	CONSTRAINT uq_adm_stat_program UNIQUE (adm_stat_id, program_id),
	CONSTRAINT school_admission_detail_adm_stat_id_fkey FOREIGN KEY (adm_stat_id) REFERENCES edu.school_admission_stat(adm_stat_id) ON DELETE CASCADE ON UPDATE CASCADE,
	CONSTRAINT school_admission_detail_program_id_fkey FOREIGN KEY (program_id) REFERENCES edu.study_program(program_id) ON DELETE RESTRICT ON UPDATE CASCADE
);
CREATE INDEX idx_admission_detail_stat_program ON edu.school_admission_detail USING btree (adm_stat_id, program_id);
CREATE TABLE edu.school_admission_stat (
	adm_stat_id int4 GENERATED BY DEFAULT AS IDENTITY( INCREMENT BY 1 MINVALUE 1 MAXVALUE 2147483647 START 1 CACHE 1 NO CYCLE) NOT NULL,
	school_id int4 NOT NULL,
	"year" int2 NOT NULL,
	applicants_cnt int4 DEFAULT 0 NOT NULL,
	enrolled_cnt int4 DEFAULT 0 NOT NULL,
	enrolled_avg_score numeric(5, 2) NULL,
	external_key text NULL,
	CONSTRAINT chk_adm_year CHECK (((year >= 2000) AND (year <= 2100))),
	CONSTRAINT chk_applicants_nonneg CHECK ((applicants_cnt >= 0)),
	CONSTRAINT chk_enrolled_avg_score_range CHECK (((enrolled_avg_score IS NULL) OR ((enrolled_avg_score >= (0)::numeric) AND (enrolled_avg_score <= (100)::numeric)))),
	CONSTRAINT chk_enrolled_le_applicants CHECK ((enrolled_cnt <= applicants_cnt)),
	CONSTRAINT chk_enrolled_nonneg CHECK ((enrolled_cnt >= 0)),
	CONSTRAINT school_admission_stat_pkey PRIMARY KEY (adm_stat_id),
	CONSTRAINT uq_school_adm_year UNIQUE (school_id, year),
	CONSTRAINT school_admission_stat_school_id_fkey FOREIGN KEY (school_id) REFERENCES edu.school(school_id) ON DELETE CASCADE ON UPDATE CASCADE
);
CREATE INDEX idx_admission_stat_school_year ON edu.school_admission_stat USING btree (school_id, year);
CREATE INDEX idx_admission_stat_year ON edu.school_admission_stat USING btree (year);
CREATE TABLE edu.school_external_key (
	ext_key_id int4 GENERATED BY DEFAULT AS IDENTITY( INCREMENT BY 1 MINVALUE 1 MAXVALUE 2147483647 START 1 CACHE 1 NO CYCLE) NOT NULL,
	school_id int4 NOT NULL,
	source_name edu."school_source" NOT NULL,
	external_key text NOT NULL,
	normalized_name text NULL,
	CONSTRAINT school_external_key_pkey PRIMARY KEY (ext_key_id),
	CONSTRAINT uq_school_source UNIQUE (school_id, source_name),
	CONSTRAINT uq_source_external_key UNIQUE (source_name, external_key),
	CONSTRAINT school_external_key_school_id_fkey FOREIGN KEY (school_id) REFERENCES edu.school(school_id) ON DELETE CASCADE ON UPDATE CASCADE
);
CREATE INDEX idx_school_external_key_school_id ON edu.school_external_key USING btree (school_id);
CREATE TABLE edu.school_profile (
	profile_id int4 GENERATED BY DEFAULT AS IDENTITY( INCREMENT BY 1 MINVALUE 1 MAXVALUE 2147483647 START 1 CACHE 1 NO CYCLE) NOT NULL,
	"name" text NOT NULL,
	CONSTRAINT school_profile_name_key UNIQUE (name),
	CONSTRAINT school_profile_pkey PRIMARY KEY (profile_id)
);
CREATE TABLE edu.school_profile_link (
	school_id int4 NOT NULL,
	profile_id int4 NOT NULL,
	CONSTRAINT school_profile_link_pkey PRIMARY KEY (school_id, profile_id),
	CONSTRAINT school_profile_link_profile_id_fkey FOREIGN KEY (profile_id) REFERENCES edu.school_profile(profile_id) ON DELETE RESTRICT ON UPDATE CASCADE,
	CONSTRAINT school_profile_link_school_id_fkey FOREIGN KEY (school_id) REFERENCES edu.school(school_id) ON DELETE CASCADE ON UPDATE CASCADE
);
CREATE INDEX idx_school_profile_link_profile ON edu.school_profile_link USING btree (profile_id);
CREATE INDEX idx_school_profile_link_profile_school ON edu.school_profile_link USING btree (profile_id, school_id);
CREATE INDEX idx_school_profile_link_school ON edu.school_profile_link USING btree (school_id);
CREATE TABLE edu.study_program (
	program_id int4 GENERATED BY DEFAULT AS IDENTITY( INCREMENT BY 1 MINVALUE 1 MAXVALUE 2147483647 START 1 CACHE 1 NO CYCLE) NOT NULL,
	institute_id int4 NOT NULL,
	code varchar(20) NOT NULL,
	"name" text NOT NULL,
	is_active bool DEFAULT true NOT NULL,
	CONSTRAINT study_program_code_key UNIQUE (code),
	CONSTRAINT study_program_pkey PRIMARY KEY (program_id),
	CONSTRAINT study_program_institute_id_fkey FOREIGN KEY (institute_id) REFERENCES edu.institute(institute_id) ON DELETE RESTRICT ON UPDATE CASCADE
);
CREATE INDEX idx_study_program_institute_id ON edu.study_program USING btree (institute_id);
