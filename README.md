# Загрузка данных об образовательных учреждениях в PostgreSQL

## Описание

Этот скрипт обрабатывает данные об образовательных учреждениях из Excel-файлов и загружает их в реляционную базу данных PostgreSQL.

## Функциональность

- Чтение данных из Excel-файлов
- Автоматическое сокращение полных названий школ до стандартных аббревиатур
- Извлечение названий регионов, муниципалитетов и школ
- Загрузка данных в PostgreSQL с автоматическим разрешением дубликатов
- Подробное логирование процесса

## Установка

### 1. Установите зависимости

```bash
pip install -r requirements.txt
```

### 2. Создайте структуру базы данных

Выполните следующий SQL-скрипт в вашей PostgreSQL базе данных:

```sql
-- Создание схемы
CREATE SCHEMA IF NOT EXISTS edu;

-- Таблица регионов
CREATE TABLE edu.region (
    region_id int4 GENERATED BY DEFAULT AS IDENTITY NOT NULL,
    name text NOT NULL,
    CONSTRAINT region_pkey PRIMARY KEY (region_id),
    CONSTRAINT region_name_key UNIQUE (name)
);

-- Таблица муниципалитетов
CREATE TABLE edu.municipality (
    municipality_id int4 GENERATED BY DEFAULT AS IDENTITY NOT NULL,
    region_id int4 NOT NULL,
    name text NOT NULL,
    CONSTRAINT municipality_pkey PRIMARY KEY (municipality_id),
    CONSTRAINT uq_municipality_region_name UNIQUE (region_id, name),
    CONSTRAINT municipality_region_id_fkey FOREIGN KEY (region_id) 
        REFERENCES edu.region(region_id)
);

-- Таблица школ
CREATE TABLE edu.school (
    school_id int4 GENERATED BY DEFAULT AS IDENTITY NOT NULL,
    municipality_id int4 NOT NULL,
    full_name text NOT NULL,
    is_active bool DEFAULT true NOT NULL,
    CONSTRAINT school_pkey PRIMARY KEY (school_id),
    CONSTRAINT uq_school_municipality_full_name UNIQUE (municipality_id, full_name),
    CONSTRAINT school_municipality_id_fkey FOREIGN KEY (municipality_id) 
        REFERENCES edu.municipality(municipality_id)
);
```

### 3. Настройте параметры подключения

Откройте файл `load_schools_to_db.py` и измените параметры подключения к БД:

```python
DB_CONFIG = {
    'host': 'localhost',          # Адрес сервера PostgreSQL
    'port': 5432,                 # Порт PostgreSQL
    'database': 'education_db',   # Название вашей базы данных
    'user': 'postgres',           # Имя пользователя
    'password': 'your_password'   # Пароль
}
```

### 4. Укажите пути к Excel-файлам

В том же файле укажите пути к вашим Excel-файлам:

```python
EXCEL_FILES = [
    'путь/к/первому/файлу.xlsx',
    'путь/к/второму/файлу.xlsx'
]
```

## Использование

Запустите скрипт:

```bash
python load_schools_to_db.py
```

## Примеры сокращений названий школ

Скрипт автоматически сокращает полные названия школ:

| До обработки | После обработки |
|-------------|----------------|
| Муниципальное автономное общеобразовательное учреждение средняя общеобразовательная школа № 1 | МАОУ СОШ № 1 |
| Муниципальное бюджетное общеобразовательное учреждение "Лицей № 2" | МБОУ Лицей № 2 |
| Государственное общеобразовательное учреждение "Гимназия № 3" | ГОУ Гимназия № 3 |

Если название уже сокращено или не подпадает под стандартные шаблоны, оно остаётся без изменений.

## Логирование

Скрипт выводит подробную информацию о процессе:

- Количество прочитанных строк из каждого файла
- Количество найденных уникальных регионов, муниципалитетов и школ
- Количество добавленных записей в каждую таблицу
- Сообщения об ошибках (если возникли)

## Обработка дубликатов

Скрипт использует механизм `ON CONFLICT DO NOTHING`, поэтому:

- Повторная загрузка тех же данных не создаст дубликатов
- Можно безопасно запускать скрипт несколько раз
- Будут добавлены только новые записи

## Требования к Excel-файлам

### Обязательные требования:

1. Файл должен быть в формате .xlsx
2. Должны присутствовать столбцы с муниципалитетом и школой
3. Заголовки должны содержать текст "Муниципальное образование" и "Образовательная организация"

### Рекомендации для лучшей работы:

- Удалите объединённые ячейки
- Уберите сложное форматирование
- Убедитесь в консистентности названий регионов и муниципалитетов
- Удалите пустые строки между данными
- Удалите строки с промежуточными итогами

## Возможные проблемы и решения

### Ошибка подключения к БД

**Проблема:** `psycopg2.OperationalError: could not connect to server`

**Решение:** 
- Проверьте параметры подключения в `DB_CONFIG`
- Убедитесь, что PostgreSQL запущен
- Проверьте права доступа пользователя

### Не найдена строка с заголовками

**Проблема:** `⚠️ Не найдена строка с заголовками в файле`

**Решение:**
- Проверьте структуру Excel-файла
- Убедитесь, что заголовки содержат текст "Муниципальное образование"
- При необходимости измените логику поиска заголовков в функции `read_excel_files()`

### Ошибка импорта данных

**Проблема:** Некоторые записи не импортируются

**Решение:**
- Проверьте логи на наличие пустых значений
- Убедитесь, что все строки имеют заполненные поля муниципалитета и школы
- Проверьте кодировку файла

## Лицензия

Этот скрипт предоставляется "как есть" без каких-либо гарантий.
