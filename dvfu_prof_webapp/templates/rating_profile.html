{% extends "base.html" %}
{% block content %}
<h1>Подбор и рейтинг школ</h1>

<form method="get" action="/rating/profile" class="card search-form rating-form">
  <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
  <div class="search-grid rating-grid">
    <label class="field field-q">Название школы (поиск по вхождению)
      <input name="q" value="{{ filters.q }}" placeholder="Например: лицей №23">
    </label>

    <label class="field">Год
      <select name="year">
        <option value="">Все</option>
        {% for y in years %}
          <option value="{{ y.year }}" {% if filters.year == y.year %}selected{% endif %}>{{ y.year }}</option>
        {% endfor %}
      </select>
    </label>

    <label class="field">План/факт
      <select name="kind">
        <option value="">Все</option>
        {% for k in kinds %}
          <option value="{{ k.kind }}" {% if filters.kind == k.kind %}selected{% endif %}>{{ k.kind }}</option>
        {% endfor %}
      </select>
    </label>

    <div class="field field-wide">
      <span class="picker-label">Профили школы</span>
      <div class="multi-dropdown" data-role="dropdown">
        <button type="button" class="multi-dropdown-toggle" data-role="toggle" aria-expanded="false">
          <span class="multi-dropdown-value" data-role="label">Не выбрано</span>
          <span class="multi-dropdown-arrow" aria-hidden="true">▾</span>
        </button>
        <div class="multi-dropdown-menu" data-role="menu">
          <div class="multi-dropdown-options">
            {% for p in profiles %}
              <label class="multi-dropdown-option">
                <input
                  type="checkbox"
                  name="profile_ids"
                  value="{{ p.profile_id }}"
                  data-title="{{ p.name }}"
                  {% if p.profile_id in filters.profile_ids %}checked{% endif %}
                >
                <span class="multi-dropdown-option-text">{{ p.name }}</span>
                <span class="multi-dropdown-check" aria-hidden="true">✓</span>
              </label>
            {% endfor %}
          </div>
        </div>
      </div>
    </div>

    <div class="field field-wide">
      <span class="picker-label">Наличие сданных предметов ЕГЭ</span>
      <div class="multi-dropdown" data-role="dropdown">
        <button type="button" class="multi-dropdown-toggle" data-role="toggle" aria-expanded="false">
          <span class="multi-dropdown-value" data-role="label">Не выбрано</span>
          <span class="multi-dropdown-arrow" aria-hidden="true">▾</span>
        </button>
        <div class="multi-dropdown-menu" data-role="menu">
          <div class="multi-dropdown-options">
            {% for s in subjects %}
              <label class="multi-dropdown-option">
                <input
                  type="checkbox"
                  name="subject_ids"
                  value="{{ s.subject_id }}"
                  data-title="{{ s.name }}"
                  {% if s.subject_id in filters.subject_ids %}checked{% endif %}
                >
                <span class="multi-dropdown-option-text">{{ s.name }}</span>
                <span class="multi-dropdown-check" aria-hidden="true">✓</span>
              </label>
            {% endfor %}
          </div>
        </div>
      </div>
    </div>

    <div class="field field-wide rating-scope-field">
      <span class="picker-label">Институты</span>
      <div class="multi-dropdown" data-role="dropdown">
        <button type="button" class="multi-dropdown-toggle" data-role="toggle" aria-expanded="false">
          <span class="multi-dropdown-value" data-role="label">Не выбрано</span>
          <span class="multi-dropdown-arrow" aria-hidden="true">▾</span>
        </button>
        <div class="multi-dropdown-menu" data-role="menu">
          <div class="multi-dropdown-options">
            {% for i in institutes %}
              <label class="multi-dropdown-option">
                <input
                  type="checkbox"
                  name="institute_ids"
                  value="{{ i.institute_id }}"
                  data-title="{{ i.name }}"
                  {% if i.institute_id in filters.institute_ids %}checked{% endif %}
                >
                <span class="multi-dropdown-option-text">{{ i.name }}</span>
                <span class="multi-dropdown-check" aria-hidden="true">✓</span>
              </label>
            {% endfor %}
          </div>
        </div>
      </div>
    </div>

    <div class="field field-wide rating-scope-field" id="program_picker_container">
      <span class="picker-label">Направления (программы)</span>
      <div class="multi-dropdown" data-role="dropdown">
        <button type="button" class="multi-dropdown-toggle" data-role="toggle" aria-expanded="false">
          <span class="multi-dropdown-value" data-role="label">Не выбрано</span>
          <span class="multi-dropdown-arrow" aria-hidden="true">▾</span>
        </button>
        <div class="multi-dropdown-menu" data-role="menu">
          <div class="multi-dropdown-options" id="program_picker_options">
            {% for p in programs %}
              {% set title = ((p.code ~ ' ') if p.code else '') ~ p.name %}
              <label class="multi-dropdown-option">
                <input
                  type="checkbox"
                  name="program_ids"
                  value="{{ p.program_id }}"
                  data-title="{{ title }}"
                  {% if p.program_id in filters.program_ids %}checked{% endif %}
                >
                <span class="multi-dropdown-option-text">
                  {{ p.institute_name }}: {% if p.code %}{{ p.code }} {% endif %}{{ p.name }}
                </span>
                <span class="multi-dropdown-check" aria-hidden="true">✓</span>
              </label>
            {% endfor %}
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="rating-key-row">
    <label class="field">Регион
      <select name="region_id" id="rating_region_id">
        <option value="">Все</option>
        {% for r in regions %}
          <option value="{{ r.region_id }}" {% if filters.region_id == r.region_id %}selected{% endif %}>{{ r.name }}</option>
        {% endfor %}
      </select>
    </label>

    <label class="field">Муниципалитет
      <select name="municipality_id" id="rating_municipality_id">
        <option value="">Все</option>
        {% for m in municipalities %}
          <option value="{{ m.municipality_id }}" {% if filters.municipality_id == m.municipality_id %}selected{% endif %}>{{ m.name }}</option>
        {% endfor %}
      </select>
    </label>

    <label class="field">Строк в рейтинге
      <select name="limit">
        {% for n in [50, 100, 200, 300, 500, 1000] %}
          <option value="{{ n }}" {% if filters.limit == n %}selected{% endif %}>{{ n }}</option>
        {% endfor %}
      </select>
    </label>

    <label class="field">Мин. среднее выпускников
      <input type="number" name="min_graduates" min="0" value="{{ filters.min_graduates }}">
    </label>

    <label class="field">Мин. средний балл
      <input type="number" name="min_avg_score" min="0" max="100" step="0.1" value="{{ filters.min_avg_score }}">
    </label>
  </div>

  <div class="weights-row">
    <label class="field">Вес: выпускники
      <input type="number" name="w_graduates" min="0" step="0.01" value="{{ filters.w_graduates }}">
    </label>

    <label class="field">Вес: средний балл
      <input type="number" name="w_avg_score" min="0" step="0.01" value="{{ filters.w_avg_score }}">
    </label>

    <label class="field">Вес: потенциальные абитуриенты
      <input type="number" name="w_match_share" min="0" step="0.01" value="{{ filters.w_match_share }}">
    </label>

    <label class="field">Вес: пороги ЕГЭ
      <input type="number" name="w_threshold_share" min="0" step="0.01" value="{{ filters.w_threshold_share }}">
    </label>
  </div>

  <label class="checkbox-row">
    <input type="checkbox" name="enforce_subject_threshold" value="1" {% if filters.enforce_subject_threshold %}checked{% endif %}>
    Проверять пороги предметов (минимальные баллы ЕГЭ)
  </label>

  <div class="rating-help-row" aria-label="Подсказки по рейтингу">
    <button
      type="button"
      class="hint-pill"
      data-tip="Средние показатели школы считаются по выбранному периоду (год и план/факт). Если фильтры периода не заданы, берутся все доступные годы."
    >
      Как считаются средние
    </button>
    <button
      type="button"
      class="hint-pill"
      data-tip="Если включена проверка порогов, то при выбранных предметах/направлениях проверяются только нужные предметы. Если выбор не задан - проверяются пороги по всем предметам ЕГЭ школы."
    >
      Проверка порогов
    </button>
    <button
      type="button"
      class="hint-pill"
      data-tip="Столбец «Средний балл ЕГЭ по предметам» появляется при выборе предметов или направлений и считается только по релевантным предметам."
    >
      Балл по предметам
    </button>
    <button
      type="button"
      class="hint-pill"
      data-tip="«Потенциальные абитуриенты» считаются по каждой подходящей программе как минимальная предметная емкость школы: для обязательных предметов берется минимум, для выборных групп — минимум из максимумов по группе; в таблицу идет среднее по таким программам. Пример: обязательные — русский 80 и математика 60, выборная группа — физика 40 или информатика 50, тогда по программе потенциал = min(60, 50) = 50."
    >
      Потенциальные абитуриенты
    </button>
  </div>

  <details class="rating-formula">
    <summary>Как рассчитывается итоговый рейтинг</summary>
    <p class="muted">
      Итоговый рейтинг складывается из 4 частей: выпускники, средний балл ЕГЭ, потенциальные абитуриенты и выполнение порогов ЕГЭ.
    </p>
    <p class="muted">
      Вы сами задаете веса этих частей. Система автоматически приводит их к сумме 1, чтобы оценка считалась корректно.
    </p>
    <p class="formula-code">
      rating_score = w_g * norm(avg_graduates) + w_a * norm(avg_score_for_rating) + w_p * norm(potential_applicants_avg) + w_t * threshold_share
    </p>
    <p class="muted formula-note">
      Простыми словами: каждый показатель переводится в шкалу от 0 до 1, умножается на свой вес, и затем все части суммируются.
      <br>
      norm(x) = x / max(x) означает: значение школы делится на лучший результат среди школ в текущей выборке.
      avg_score_for_rating = avg_score_all без предметно-программных фильтров, иначе используется средний балл по релевантным предметам.
      <br>
      threshold_share уже лежит в диапазоне от 0 до 1.
    </p>
  </details>

  <div class="row search-actions">
    <button class="btn" type="submit">Рассчитать рейтинг</button>
    {% if has_query and ranked %}
      <button class="btn" type="submit" formaction="/rating/profile/save" formmethod="post">Сохранить рейтинг</button>
    {% endif %}
    <a class="btn btn-ghost" href="/rating/export{% if current_query %}?{{ current_query }}{% endif %}">Экспорт в Excel</a>
    <a class="btn btn-ghost" href="/rating/profile">Сбросить</a>
    <a class="btn btn-ghost" href="/">В меню</a>
  </div>
</form>

{% if save_message %}
  <div class="{{ save_message_kind }}">{{ save_message }}</div>
{% endif %}

{% if program_requirements %}
  <div class="card">
    <div class="results-head">
      <h2>Требования выбранных направлений</h2>
      <p class="muted">Сопоставление школ выполняется по обязательным предметам и группе choice-предметов.</p>
    </div>
    <div class="requirements-grid">
      {% for p in program_requirements %}
        <article class="requirements-card">
          <h3>{% if p.code %}{{ p.code }} {% endif %}{{ p.name }}</h3>
          <p class="muted">{{ p.institute_name }}</p>
          <p><b>Обязательные:</b>
            {% if p.required_subjects %}
              {{ p.required_subjects | map(attribute='name') | join(', ') }}
            {% else %}
              —
            {% endif %}
          </p>
          <p><b>Choice:</b>
            {% if p.choice_subjects %}
              {{ p.choice_subjects | map(attribute='name') | join(', ') }}
            {% else %}
              —
            {% endif %}
          </p>
        </article>
      {% endfor %}
    </div>
  </div>
{% endif %}

{% if has_query %}
  <div class="card results-card">
    <div class="results-head">
      <h2>Рейтинг школ</h2>
      <p class="muted results-count">Найдено: {{ total }}</p>
    </div>

    {% if ranked %}
      <div class="rating-viz-grid">
        <section class="rating-viz-card">
          <div class="results-head rating-viz-head">
            <h3>Состав рейтинга (топ-10)</h3>
            <p class="muted">Вклад 4 компонентов в <code>rating_score</code> для каждой школы.</p>
          </div>
          <div id="ratingStackedChart" class="rating-stacked-chart"></div>
          <div class="rating-stacked-legend">
            <span class="legend-chip"><span class="legend-dot legend-dot-graduates"></span>Выпускники</span>
            <span class="legend-chip"><span class="legend-dot legend-dot-avg"></span>Средний балл</span>
            <span class="legend-chip"><span class="legend-dot legend-dot-potential"></span>Потенциальные абитуриенты</span>
            <span class="legend-chip"><span class="legend-dot legend-dot-threshold"></span>Пороги</span>
          </div>
        </section>
      </div>

      <div class="table-wrap">
        <table class="table table-clickable rating-results-table">
          <thead>
            <tr>
              <th>Место</th>
              <th>Регион</th>
              <th>Муниципалитет</th>
              <th>Школа</th>
              <th>Профили</th>
              <th>Среднее выпускников</th>
              <th>Средний балл ЕГЭ</th>
              {% if show_admission_subject_avg %}
                <th>Средний балл ЕГЭ по предметам</th>
              {% endif %}
              {% if show_potential_applicants %}
                <th>Потенциальные абитуриенты</th>
              {% endif %}
              <th>Итоговый рейтинг</th>
              <th></th>
            </tr>
          </thead>
          <tbody>
            {% for r in ranked %}
              <tr data-href="/search/school/{{ r.school_id }}?src=rating{% if current_query %}&{{ current_query }}{% endif %}">
                <td>{{ r.rank_pos }}</td>
                <td>{{ r.region_name }}</td>
                <td>{{ r.municipality_name }}</td>
                <td>{{ r.full_name }}</td>
                <td>{{ r.profile_names if r.profile_names else "—" }}</td>
                <td>{{ (r.avg_graduates | float | round(0, 'common') | int) if r.avg_graduates is not none else "—" }}</td>
                <td>{{ r.avg_score_all if r.avg_score_all is not none else "—" }}</td>
                {% if show_admission_subject_avg %}
                  <td>{{ r.admission_subject_avg if r.admission_subject_avg is not none else "—" }}</td>
                {% endif %}
                {% if show_potential_applicants %}
                  <td>{{ (r.potential_applicants_avg | float | round(0, 'common') | int) if r.potential_applicants_avg is not none else "—" }}</td>
                {% endif %}
                <td>{{ r.rating_score }}</td>
                <td>
                  <a class="btn btn-small" href="/search/school/{{ r.school_id }}?src=rating{% if current_query %}&{{ current_query }}{% endif %}" onclick="event.stopPropagation();">Карточка</a>
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <div class="alert">По заданным фильтрам подходящих школ не найдено.</div>
    {% endif %}
  </div>
{% else %}
  <div class="card">
    <p class="muted">Выберите фильтры и нажмите «Рассчитать рейтинг», чтобы построить список школ.</p>
  </div>
{% endif %}

<script>
  const regionSelect = document.getElementById("rating_region_id");
  const municipalitySelect = document.getElementById("rating_municipality_id");
  const programsOptionsNode = document.getElementById("program_picker_options");
  const ratingStackedRows = {{ rating_chart_stacked | tojson }};
  let stackedTooltipNode = null;

  function formatNumber(value, digits = 2) {
    const num = Number(value);
    if (!Number.isFinite(num)) return "—";
    return num.toFixed(digits);
  }

  function getStackedTooltipNode() {
    if (stackedTooltipNode && document.body.contains(stackedTooltipNode)) {
      return stackedTooltipNode;
    }
    stackedTooltipNode = document.createElement("div");
    stackedTooltipNode.className = "stacked-tooltip";
    document.body.appendChild(stackedTooltipNode);
    return stackedTooltipNode;
  }

  function hideStackedTooltip() {
    if (!stackedTooltipNode) return;
    stackedTooltipNode.classList.remove("visible");
  }

  function placeStackedTooltip(clientX, clientY) {
    const tooltip = stackedTooltipNode;
    if (!tooltip) return;
    const pad = 10;
    const offset = 14;
    const tooltipWidth = tooltip.offsetWidth || 0;
    const tooltipHeight = tooltip.offsetHeight || 0;

    let left = clientX + offset;
    let top = clientY - tooltipHeight - offset;

    if (left + tooltipWidth + pad > window.innerWidth) {
      left = window.innerWidth - tooltipWidth - pad;
    }
    if (left < pad) {
      left = pad;
    }
    if (top < pad) {
      top = clientY + offset;
    }
    if (top + tooltipHeight + pad > window.innerHeight) {
      top = window.innerHeight - tooltipHeight - pad;
    }

    tooltip.style.left = `${left}px`;
    tooltip.style.top = `${top}px`;
  }

  function showStackedTooltip(clientX, clientY, text) {
    const tooltip = getStackedTooltipNode();
    tooltip.textContent = text;
    tooltip.classList.add("visible");
    placeStackedTooltip(clientX, clientY);
  }

  function renderStackedChart() {
    const root = document.getElementById("ratingStackedChart");
    if (!root) return;
    hideStackedTooltip();
    root.innerHTML = "";

    if (!Array.isArray(ratingStackedRows) || ratingStackedRows.length === 0) {
      const msg = document.createElement("p");
      msg.className = "muted";
      msg.textContent = "Недостаточно данных для графика состава рейтинга.";
      root.appendChild(msg);
      return;
    }

    const maxScore = Math.max(
      0.000001,
      ...ratingStackedRows.map((row) => Number(row.score_total) || 0)
    );
    const segments = [
      { key: "score_part_graduates", className: "stacked-graduates", label: "Выпускники" },
      { key: "score_part_avg_score", className: "stacked-avg", label: "Средний балл" },
      { key: "score_part_potential", className: "stacked-potential", label: "Потенциальные абитуриенты" },
      { key: "score_part_threshold", className: "stacked-threshold", label: "Пороги" },
    ];

    ratingStackedRows.forEach((row) => {
      const line = document.createElement("div");
      line.className = "stacked-row";

      const label = document.createElement("div");
      label.className = "stacked-label";
      label.textContent = `#${row.rank_pos} ${row.name || ""}`;
      line.appendChild(label);

      const track = document.createElement("div");
      track.className = "stacked-track";
      const titleParts = [];
      segments.forEach((segment) => {
        const value = Number(row[segment.key]) || 0;
        const total = Math.max(0, Number(row.score_total) || 0);
        const sharePct = total > 0 ? (value / total) * 100 : 0;
        const width = (value / maxScore) * 100;
        titleParts.push(`${segment.label}: ${formatNumber(value, 4)}`);
        if (width <= 0) return;
        const part = document.createElement("span");
        part.className = `stacked-segment ${segment.className}`;
        part.style.width = `${width}%`;
        const tooltipText = `${segment.label}: ${formatNumber(value, 4)} (${formatNumber(sharePct, 1)}%)`;
        part.setAttribute("aria-label", tooltipText);
        part.tabIndex = 0;
        part.addEventListener("mouseenter", (event) => {
          showStackedTooltip(event.clientX, event.clientY, tooltipText);
        });
        part.addEventListener("mousemove", (event) => {
          placeStackedTooltip(event.clientX, event.clientY);
        });
        part.addEventListener("mouseleave", () => {
          hideStackedTooltip();
        });
        part.addEventListener("focus", (event) => {
          const target = event.currentTarget;
          if (!(target instanceof HTMLElement)) return;
          const rect = target.getBoundingClientRect();
          showStackedTooltip(rect.left + (rect.width / 2), rect.top, tooltipText);
        });
        part.addEventListener("blur", () => {
          hideStackedTooltip();
        });
        track.appendChild(part);
      });
      track.title = titleParts.join("\n");
      line.appendChild(track);

      const score = document.createElement("div");
      score.className = "stacked-score";
      score.textContent = formatNumber(row.score_total, 4);
      line.appendChild(score);

      root.appendChild(line);
    });
  }

  function initMultiDropdown(root) {
    const toggle = root.querySelector("[data-role='toggle']");
    const labelNode = root.querySelector("[data-role='label']");
    const checkboxes = Array.from(root.querySelectorAll("input[type='checkbox']"));
    if (!toggle || !labelNode || checkboxes.length === 0) return;

    const close = () => {
      root.classList.remove("open");
      toggle.setAttribute("aria-expanded", "false");
    };
    const open = () => {
      root.classList.add("open");
      toggle.setAttribute("aria-expanded", "true");
    };

    const updateLabel = () => {
      const selected = checkboxes.filter((cb) => cb.checked).map((cb) => cb.dataset.title || cb.value);
      if (selected.length === 0) {
        labelNode.textContent = "Не выбрано";
      } else if (selected.length <= 2) {
        labelNode.textContent = selected.join(", ");
      } else {
        labelNode.textContent = `Выбрано: ${selected.length}`;
      }
      root.classList.toggle("has-value", selected.length > 0);
    };

    toggle.addEventListener("click", (e) => {
      e.preventDefault();
      root.classList.contains("open") ? close() : open();
    });

    checkboxes.forEach((cb) => cb.addEventListener("change", updateLabel));
    document.addEventListener("click", (e) => { if (!root.contains(e.target)) close(); });
    document.addEventListener("keydown", (e) => { if (e.key === "Escape") close(); });
    updateLabel();
  }

  function initAllDropdowns() {
    document.querySelectorAll(".multi-dropdown").forEach((node) => {
      if (!node.dataset.inited) {
        node.dataset.inited = "1";
        initMultiDropdown(node);
      }
    });
  }

  async function reloadMunicipalities() {
    if (!regionSelect || !municipalitySelect) return;
    const regionId = regionSelect.value;
    municipalitySelect.innerHTML = '<option value="">Все</option>';
    if (!regionId) return;
    const resp = await fetch(`/search/municipalities?region_id=${encodeURIComponent(regionId)}`);
    if (!resp.ok) return;
    const data = await resp.json();
    (data.items || []).forEach((item) => {
      const opt = document.createElement("option");
      opt.value = item.municipality_id;
      opt.textContent = item.name;
      municipalitySelect.appendChild(opt);
    });
  }

  async function reloadPrograms() {
    if (!programsOptionsNode) return;
    const selected = new Set(
      Array.from(programsOptionsNode.querySelectorAll("input[type='checkbox']:checked")).map((cb) => cb.value)
    );
    const selectedInstituteIds = Array.from(
      document.querySelectorAll("input[name='institute_ids']:checked")
    ).map((cb) => cb.value);

    let endpoint = "/rating/programs";
    if (selectedInstituteIds.length > 0) {
      const params = new URLSearchParams();
      selectedInstituteIds.forEach((id) => params.append("institute_ids", id));
      endpoint = `/rating/programs?${params.toString()}`;
    }

    const resp = await fetch(endpoint);
    if (!resp.ok) return;
    const data = await resp.json();
    const items = data.items || [];
    programsOptionsNode.innerHTML = "";
    items.forEach((item) => {
      const label = document.createElement("label");
      label.className = "multi-dropdown-option";

      const input = document.createElement("input");
      input.type = "checkbox";
      input.name = "program_ids";
      input.value = String(item.program_id);
      const title = `${item.code ? item.code + " " : ""}${item.name}`;
      input.dataset.title = title;
      if (selected.has(input.value)) {
        input.checked = true;
      }

      const text = document.createElement("span");
      text.className = "multi-dropdown-option-text";
      text.textContent = `${item.institute_name}: ${title}`;

      const check = document.createElement("span");
      check.className = "multi-dropdown-check";
      check.setAttribute("aria-hidden", "true");
      check.textContent = "✓";

      label.appendChild(input);
      label.appendChild(text);
      label.appendChild(check);
      programsOptionsNode.appendChild(label);
    });

    const root = programsOptionsNode.closest(".multi-dropdown");
    if (root) {
      root.dataset.inited = "";
      initAllDropdowns();
    }
  }

  if (regionSelect) {
    regionSelect.addEventListener("change", () => {
      reloadMunicipalities().catch((e) => console.error(e));
    });
  }

  document.querySelectorAll("input[name='institute_ids']").forEach((cb) => {
    cb.addEventListener("change", () => {
      reloadPrograms().catch((e) => console.error(e));
    });
  });

  initAllDropdowns();
  renderStackedChart();

  window.addEventListener("scroll", hideStackedTooltip, { passive: true });

  document.querySelectorAll("tr[data-href]").forEach((row) => {
    row.addEventListener("click", () => {
      const href = row.getAttribute("data-href");
      if (href) window.location.href = href;
    });
  });
</script>
{% endblock %}
