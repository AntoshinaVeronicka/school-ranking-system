{% extends "base.html" %}
{% block content %}
<h1>Карточка школы</h1>

{% if school %}
  <div class="card">
    <p><b>Регион:</b> {{ school.region_name }}</p>
    <p><b>Муниципалитет:</b> {{ school.municipality_name }}</p>
    <p><b>Школа:</b> {{ school.full_name }}</p>
    <p><b>Активна:</b> {{ "да" if school.is_active else "нет" }}</p>
    <p>
      <b>Профили:</b>
      {% if school.profiles %}
        {{ school.profiles | join(", ") }}
      {% else %}
        —
      {% endif %}
    </p>
  </div>

  <div class="card">
    <h2>Предметная аналитика ЕГЭ</h2>
    {% if subject_heatmap_rows %}
      <p class="muted">
        Метрики в колонках усреднены по {{ subject_heatmap_period if subject_heatmap_period else "всем данным факта" }}.
      </p>
      <div class="subject-table-wrap">
        <table class="table subject-heatmap-table">
          <thead>
            <tr>
              <th>Предмет</th>
              <th>Средний балл</th>
              <th>Участники</th>
              <th>% не преодолели</th>
              <th>% 80+</th>
              <th>% 100</th>
              <th>Светофор порогов</th>
            </tr>
          </thead>
          <tbody>
          {% for row in subject_heatmap_rows %}
            <tr>
              <td>{{ row.subject_name }}</td>
              <td class="heat-cell" style="background-color: {{ row.avg_score_heat }};">
                {{ row.avg_score if row.avg_score is not none else "—" }}
              </td>
              <td class="heat-cell" style="background-color: {{ row.participants_heat }};">
                {{ row.participants_cnt if row.participants_cnt is not none else "—" }}
              </td>
              <td class="heat-cell" style="background-color: {{ row.not_passed_heat }};">
                {{ (row.not_passed_pct ~ "%") if row.not_passed_pct is not none else "—" }}
              </td>
              <td class="heat-cell" style="background-color: {{ row.high_80_99_heat }};">
                {{ (row.high_80_99_pct ~ "%") if row.high_80_99_pct is not none else "—" }}
              </td>
              <td class="heat-cell" style="background-color: {{ row.score_100_heat }};">
                {{ (row.score_100_pct ~ "%") if row.score_100_pct is not none else "—" }}
              </td>
              <td class="threshold-cell">
                {% if row.avg_score is not none and row.min_passing_score is not none %}
                  <div class="threshold-meter threshold-{{ row.threshold_status }}">
                    <span class="threshold-value" style="width: {{ row.avg_score_pos }}%;"></span>
                    <span class="threshold-marker" style="left: {{ row.min_score_pos }}%;"></span>
                  </div>
                  <div class="threshold-note">
                    средний балл {{ row.avg_score }} / порог {{ row.min_passing_score }}
                    {% if row.threshold_delta is not none %}
                      ({{ "+" if row.threshold_delta > 0 else "" }}{{ row.threshold_delta }})
                    {% endif %}
                  </div>
                {% else %}
                  —
                {% endif %}
              </td>
            </tr>
          {% endfor %}
          </tbody>
        </table>
      </div>

      {% if subject_histogram_rows %}
        <h3>Сравнение по предметам</h3>
        <p class="muted subject-compare-meta">
          {% if subject_histogram_latest_year and subject_histogram_prev_year %}
            Показан последний фактический год {{ subject_histogram_latest_year }} и изменение к {{ subject_histogram_prev_year }}.
          {% elif subject_histogram_latest_year %}
            Показан последний фактический год {{ subject_histogram_latest_year }}.
          {% endif %}
        </p>
        <div class="subject-table-wrap">
          <table class="table subject-compare-table">
            <colgroup>
              <col class="subject-compare-col-subject">
              <col class="subject-compare-col-bar">
              <col class="subject-compare-col-value">
              <col class="subject-compare-col-delta">
            </colgroup>
            <thead>
              <tr>
                <th>Предмет</th>
                <th>Средний балл</th>
                <th>Значение</th>
                <th>Δ к предыдущему году</th>
              </tr>
            </thead>
            <tbody>
            {% for row in subject_histogram_rows %}
              <tr>
                <td class="hist-label">{{ row.subject_name }}</td>
                <td>
                  <div class="hist-bar-wrap">
                    <div class="hist-bar" style="width: {{ row.bar_width }}%; background: {{ row.bar_gradient }};"></div>
                  </div>
                </td>
                <td class="hist-score">{{ row.latest_score if row.latest_score is not none else "—" }}</td>
                <td class="hist-delta hist-{{ row.delta_status }}">
                  {% if row.delta is not none %}
                    {{ "+" if row.delta > 0 else "" }}{{ row.delta }}
                  {% else %}
                    нет сравнения
                  {% endif %}
                </td>
              </tr>
            {% endfor %}
            </tbody>
          </table>
        </div>
      {% endif %}
    {% else %}
      <p class="muted">Недостаточно данных ЕГЭ для предметной аналитики.</p>
    {% endif %}
  </div>

  <div class="card">
    <h2>Внешние ключи</h2>
    {% if external_keys %}
      <table class="table">
        <thead>
          <tr>
            <th>Источник</th>
            <th>Ключ</th>
            <th>Нормализованное имя</th>
          </tr>
        </thead>
        <tbody>
        {% for row in external_keys %}
          <tr>
            <td>{{ row.source_name }}</td>
            <td>{{ row.external_key }}</td>
            <td>{{ row.normalized_name if row.normalized_name else "—" }}</td>
          </tr>
        {% endfor %}
        </tbody>
      </table>
    {% else %}
      <p class="muted">Нет записей.</p>
    {% endif %}
  </div>

  <div class="card">
    <h2>ЕГЭ за все доступные годы</h2>
    {% if ege_timeline %}
      {% for period in ege_timeline %}
        <h3>{{ period.year }} / {{ period.kind }} (выпускников: {{ period.graduates_total }})</h3>
        {% if period.subjects %}
          <table class="table">
            <thead>
              <tr>
                <th>Предмет</th>
                <th>Участники</th>
                <th>Не преодолели порог</th>
                <th>80-99</th>
                <th>100 баллов</th>
                <th>Средний балл</th>
                <th>Выбрали</th>
              </tr>
            </thead>
            <tbody>
            {% for s in period.subjects %}
              <tr>
                <td>{{ s.subject_name }}</td>
                <td>{{ s.participants_cnt if s.participants_cnt is not none else "—" }}</td>
                <td>{{ s.not_passed_cnt if s.not_passed_cnt is not none else "—" }}</td>
                <td>{{ s.high_80_99_cnt if s.high_80_99_cnt is not none else "—" }}</td>
                <td>{{ s.score_100_cnt if s.score_100_cnt is not none else "—" }}</td>
                <td>{{ s.avg_score if s.avg_score is not none else "—" }}</td>
                <td>{{ s.chosen_cnt if s.chosen_cnt is not none else "—" }}</td>
              </tr>
            {% endfor %}
            </tbody>
          </table>
        {% else %}
          <p class="muted">Нет предметной статистики для этого периода.</p>
        {% endif %}
      {% endfor %}
    {% else %}
      <p class="muted">Статистика ЕГЭ отсутствует.</p>
    {% endif %}
  </div>

  <div class="card">
    <h2>Статистика приёма</h2>
    {% if admission_stats %}
      <table class="table">
        <thead>
          <tr>
            <th>Год</th>
            <th>Заявлений</th>
            <th>Зачислено</th>
            <th>Средний балл зачисленных</th>
          </tr>
        </thead>
        <tbody>
        {% for row in admission_stats %}
          <tr>
            <td>{{ row.year }}</td>
            <td>{{ row.applicants_cnt }}</td>
            <td>{{ row.enrolled_cnt }}</td>
            <td>{{ row.enrolled_avg_score if row.enrolled_avg_score is not none else "—" }}</td>
          </tr>
        {% endfor %}
        </tbody>
      </table>
    {% else %}
      <p class="muted">Статистика приёма отсутствует.</p>
    {% endif %}
  </div>

  <div class="card">
    <h2>Профориентационные мероприятия</h2>
    {% if prof_events %}
      <table class="table">
        <thead>
          <tr>
            <th>Год</th>
            <th>Количество мероприятий</th>
            <th>Охват</th>
          </tr>
        </thead>
        <tbody>
        {% for row in prof_events %}
          <tr>
            <td>{{ row.year }}</td>
            <td>{{ row.events_cnt }}</td>
            <td>{{ row.coverage_cnt }}</td>
          </tr>
        {% endfor %}
        </tbody>
      </table>
    {% else %}
      <p class="muted">Данные по профориентации отсутствуют.</p>
    {% endif %}
  </div>

  <div class="row">
    <a class="btn" href="/reports">Выгрузка и отчёт</a>
    <a class="btn btn-ghost" href="/search/school/{{ school.school_id }}/export">Экспорт карточки в Excel</a>
    <a class="btn btn-ghost" href="{{ back_url }}">Назад</a>
  </div>
{% else %}
  <div class="alert">Школа не найдена.</div>
  <div class="row">
    <a class="btn btn-ghost" href="{{ back_url if back_url else '/search' }}">Назад</a>
  </div>
{% endif %}
{% endblock %}
